
-----------------------------------
-- Always Encrypted
-----------------------------------


use DB_VENDAS


-- Primeiro passo é criar uma chave de certificado 
-- Segurança > Chaves Always Encrypted > Chaves Mestre de coluna

CREATE COLUMN MASTER KEY [Chave_AlwaysEncrypted]
WITH
(
	KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
	KEY_PATH = N'CurrentUser/My/1B706A19E72431E555F758B68A1AB127158930CC'
)

GO
-- Segundo passo é criar a chave de descriptografia


CREATE COLUMN ENCRYPTION KEY [AlwaysEncrypted_Demonstracao]
WITH VALUES
(
	COLUMN_MASTER_KEY = [Chave_AlwaysEncrypted],
	ALGORITHM = 'RSA_OAEP',
	ENCRYPTED_VALUE = 0x016E000001630075007200720065006E00740075007300650072002F006D0079002F00310062003700300036006100310039006500370032003400330031006500350035003500660037003500380062003600380061003100610062003100320037003100350038003900330030006300630005DE2A2C6E14FA1B5D5490F50A4A58B8ED8C6E505A67B161CC31EA9FBDA370057C6C6766EFB72503BCFC745BD0F287007FD78C8C3036DD21F4BB4D70691A2D15567FAB3EC60DF55FC5A33D45C1C4CE5DE4322C8E8EC04EDDDDC81B48F5B606F946BD1F73A88F68CCA7C6EC52398839AD181EA2BCF0FEFE0E955E39B98FA91E523CEE0BB6EA3817ABB21059AD99829E8BCC1EFB28EE385E158D0EA750ADDAAF5D9DBE380688BC0D5808D4593BC97664DE08E71B4477E3705D456F6F4F3E42A5D9A3299C9FFEE165168C0BB76546A748AC0EFF2A5073D702E61DB4934B3850F3F899B3ED6F436A2110FA931FBB12F7DD1F33ACB367B8CE5AB8A21A9C65D0B2DAD2594EE0FB0BD3E90C01AE2E3750AF161179A8D6BA75B6C70EB55299DF8E07EA383A7A0007BC42AC53014D249E19A9B7A25DE6F58B7ABCC12911C1C477159B9D6C262E25065A7ECB3106412143FE1B86A545C6AE24FDD52B0ED40DA65F736D3DA32FEEA02931B577DB4EBEF44347625275A1A168C71901E56DB3C667C81C513C32DCD5915708F5EAA6918396AA0D8917A3E02BC9C414DF0909088C3CA921EAB716C175D8635137AE27BE38DBAE07F2E5DB818ACF495C0714746A4721AC86D07467A08F2B4BA5CF021C967DCFDEB295136B761F758274C73736CEA5A335ACE9E6A8E75487090A7F2C046D8C9F8F13B437E5B34E2103440CD7CA23523A97A664D7CA
)

GO

/*
- A criptografia determinística sempre gera o mesmo valor criptografado para qualquer valor de texto sem formatação
- A criptografia aleatória usa um método que criptografa os dados de uma maneira menos previsível
*/


-- Criando uma tabela com as colunas criptografadas

CREATE TABLE [dbo].[TB_CLIENTE](
	[COD_CLI] [int] IDENTITY(1,1) NOT NULL,
	[NOME] [varchar](50)
		COLLATE  Latin1_General_BIN2 ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = [AlwaysEncrypted_Demonstracao], 
		ENCRYPTION_TYPE = DETERMINISTIC,  
		ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256'), 
	[FANTASIA] [varchar](20) NULL,
	[CNPJ] [varchar](18) 
		COLLATE  Latin1_General_BIN2 ENCRYPTED WITH (COLUMN_ENCRYPTION_KEY = [AlwaysEncrypted_Demonstracao], 
		ENCRYPTION_TYPE = RANDOMIZED,  
		ALGORITHM = 'AEAD_AES_256_CBC_HMAC_SHA_256'), 
	[INSCRICAO] [varchar](19) NULL,
	[FONE1] [varchar](15) NULL,
	[FAX] [varchar](15) NULL,
	[E_MAIL] [varchar](35) NULL,
	[DATA_CAD] [datetime] NULL,
	[ICMS] [float] NULL,
	[REVENDA_CONSUMIDOR] [char](1) NULL,
)



-- INSERINDO DADOS VIA IMPORTAÇÃO E EXPORTAÇÃO DO SQL SERVER

-- consultando os dados 
-- para visualizar os dados adicione o parâmetro “Column Encryption Setting = enabled;”


select * from db_vendas.dbo.TB_CLIENTE
